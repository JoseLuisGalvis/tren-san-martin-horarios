<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Favicon -->
    <link rel="icon" href="../assets/images/icono.png" type="image/png" />
    <title>Vuelta: Sábado - Tren San Martín</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- FontAwesome CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- AOS CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div class="container-fluid d-flex flex-column min-vh-100 text-white">
      <!-- Header -->
      <header
        class="d-flex justify-content-between align-items-center w-100 py-3 px-4 bg-consultar"
      >
        <div>
          <span class="current-time">Hora: --:--:--</span>
          <h5 class="m-0 d-inline ms-3">
            Vuelta: Dr. Cabred → Retiro - Sábado
          </h5>
        </div>
        <div>
          <button
            class="btn p-2 rounded-circle toggle-dark-mode me-3"
            aria-label="Activar modo oscuro"
          >
            <i class="fas fa-moon moon-icon"></i>
            <i class="fas fa-sun sun-icon d-none"></i>
          </button>
          <a
            href="../html/schedule.html"
            class="btn btn-outline-light"
            aria-label="Volver al cronograma"
            >Atrás</a
          >
        </div>
      </header>

      <!-- Main -->
      <main
        class="flex-grow-1 d-flex align-items-center justify-content-center text-center px-3"
      >
        <div class="container">
          <div class="row g-4">
            <!-- Publicidad Izquierda Superior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-right"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarSab.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>

            <!-- Formulario de Búsqueda -->
            <div class="col-12 col-md-4">
              <div class="card rounded h-100">
                <div class="card-body">
                  <h5 class="card-title">Selecciona los detalles</h5>
                  <div
                    id="error-message"
                    class="alert alert-danger d-none"
                    role="alert"
                  ></div>
                  <form id="horarios-form">
                    <div class="mb-3">
                      <label for="estacion" class="form-label">Estación</label>
                      <select
                        id="estacion"
                        class="form-select"
                        required
                        aria-describedby="estacionHelp"
                      >
                        <option value="">Selecciona una estación</option>
                        <!-- Opciones cargadas por JS -->
                      </select>
                      <div id="estacionHelp" class="form-text">
                        Selecciona la estación de la que deseas consultar los
                        horarios
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="hora" class="form-label">Hora</label>
                      <input
                        type="time"
                        id="hora"
                        class="form-control"
                        required
                        aria-describedby="horaHelp"
                      />
                      <div id="horaHelp" class="form-text">
                        Ingresa la hora para consultar los próximos trenes
                      </div>
                    </div>
                    <button
                      type="submit"
                      class="btn bg-consultar w-100"
                      id="submit-btn"
                    >
                      Ver horarios
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <!-- Publicidad Derecha Superior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-left"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarSab.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>

            <!-- Publicidad Izquierda Inferior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-right"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarSab.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>

            <!-- Resultados de la Búsqueda -->
            <div class="col-12 col-md-4">
              <div class="card rounded h-100">
                <div class="card-body resultados-card">
                  <h5 class="card-title">Horarios Disponibles</h5>
                  <div
                    id="resultados"
                    class="overflow-auto"
                    style="max-height: 400px"
                  >
                    <p class="text-muted text-center" id="responseHelp">
                      Selecciona una estación y hora para ver los horarios
                      disponibles
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Publicidad Derecha Inferior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-left"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarSab.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="../js/script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Inicializar AOS
        AOS.init({
          duration: 3000,
          once: false,
        });

        const form = document.getElementById("horarios-form");
        const estacionSelect = document.getElementById("estacion");
        const horaInput = document.getElementById("hora");
        const submitBtn = document.getElementById("submit-btn");
        const resultadosDiv = document.getElementById("resultados");
        const errorDiv = document.getElementById("error-message");
        let horariosData = null;

        // Cargar horarios desde JSON estático
        fetch("../public/JSON/horarios/horarios_sabado_vuelta.json")
          .then((response) => {
            if (!response.ok) throw new Error("Error al cargar los horarios");
            return response.json();
          })
          .then((data) => {
            horariosData = data;
            data.estaciones.forEach((estacion, index) => {
              const option = document.createElement("option");
              option.value = index; // Usamos índice como valor
              option.textContent = estacion;
              estacionSelect.appendChild(option);
            });
          })
          .catch((error) => {
            errorDiv.textContent =
              "Error al cargar los horarios. Por favor, intente nuevamente.";
            errorDiv.classList.remove("d-none");
            console.error("Error fetching horarios:", error);
          });

        // Manejar formulario
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const selectedEstacionIdx = parseInt(estacionSelect.value);
          const selectedTime = horaInput.value;

          if (!horariosData || isNaN(selectedEstacionIdx) || !selectedTime) {
            errorDiv.textContent =
              "Por favor, selecciona una estación y una hora válidas.";
            errorDiv.classList.remove("d-none");
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = "Consultando...";
          errorDiv.classList.add("d-none");
          resultadosDiv.innerHTML =
            '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';

          setTimeout(() => {
            try {
              const [hours, minutes] = selectedTime.split(":").map(Number);
              const selectedMinutes = hours * 60 + minutes;

              const resultados = horariosData.trenes
                .map((tren) => {
                  const horaEstacion = tren.horarios[selectedEstacionIdx];
                  if (!horaEstacion) return null;
                  const [h, m] = horaEstacion.split(":").map(Number);
                  const trenMinutes = h * 60 + m;
                  return trenMinutes >= selectedMinutes
                    ? { num_tren: tren.numero, hora_estacion: horaEstacion }
                    : null;
                })
                .filter((tren) => tren !== null)
                .sort((a, b) => {
                  const [ha, ma] = a.hora_estacion.split(":").map(Number);
                  const [hb, mb] = b.hora_estacion.split(":").map(Number);
                  return ha * 60 + ma - (hb * 60 + mb);
                })
                .slice(0, 5); // Limita a los próximos 5 trenes

              resultadosDiv.innerHTML = "";
              if (resultados.length > 0) {
                resultados.forEach((horario) => {
                  const div = document.createElement("div");
                  div.className = "card mb-2";
                  div.innerHTML = `
                  <div class="card-body py-2">
                    <h5 class="card-subtitle mb-1">Tren ${horario.num_tren}</h5>
                    <p class="card-text m-0">Hora de salida: ${horario.hora_estacion}</p>
                  </div>
                `;
                  resultadosDiv.appendChild(div);
                });
              } else {
                resultadosDiv.innerHTML =
                  '<div class="alert alert-info" role="alert">No se encontraron horarios disponibles para la hora seleccionada.</div>';
              }
            } catch (error) {
              errorDiv.textContent =
                "Error al procesar los horarios. Por favor, intente nuevamente.";
              errorDiv.classList.remove("d-none");
              console.error("Error procesando horarios:", error);
              resultadosDiv.innerHTML = "";
            } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = "Ver horarios";
            }
          }, 500); // Retraso simulado
        });
      });
    </script>
  </body>
</html>
